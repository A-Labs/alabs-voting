<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../web3-wallet/web3-wallet.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../locals-button/locals-button.html">
<link rel="import" href="../locals-item/locals-item.html">
<link rel="import" href="../locals-style/locals-style.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../alabs-proposal/alabs-proposal.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../firebase-element/firebase.html">
<link rel="import" href="../neon-animation/neon-animated-pages.html">
<link rel="import" href="../neon-animation/neon-animation.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <alabs-voting></alabs-voting>

@group Seed Elements
@element alabs-voting
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="alabs-voting">

  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
      }

      neon-animated-pages {
      }
     .canvas {
        @apply(--locals-canvas);
      }
     .whitespace {
      height: 20px;
     }
      h1 {
       @apply(--locals-font-h1);
      }
      h2 {
       @apply(--locals-font-h2);
      }
      h3 {
       @apply(--locals-font-h3);
      }
      h4 {
       @apply(--locals-font-h4);
      }
      p {
       @apply(--locals-font-body1);
      }
      small {
       @apply(--locals-font-small);
       color: rgba(0,0,0,0.75);
      }


      .props {
        width: 100%;
        max-width: 900px;
      }


      .prop {
        box-sizing: border-box;
        padding: 14px;
        font-size: 32px;
        border-bottom: 1px dashed var(--locals-grey2); 
      }
      .prop:hover {
        margin-top: -1px;
        padding-top: 15px;

        box-sizing: border-box;
        background-color: var(--locals-grey2);
        border-bottom: 1px solid var(--locals-grey2); 
      }


    </style>

    <web3-wallet password="defaultpassword" host="http://109.123.70.141:8545" account="{{account}}" web3="{{web3}}" balance="{{balance}}" keystore="{{keystore}}"></web3-wallet>

    <iron-ajax
      id="ajax"
      handle-as="json"
      on-response="hresponse"
      debounce-duration="300"></iron-ajax>

      <div class="canvas">
        <p class="small">Current eth balance for account <span>{{account}}</span>: <span>{{balans}}</span></p>
          <locals-button txtcolor="green" on-tap="askEth">gimme eth</locals-button>
      </div>

    <neon-animated-pages selected="{{state}}">

      <neon-animatable>
      <div class="canvas">
        <div class="props">
        <locals-button txtcolor="blue" on-tap="createNew">new proposal</locals-button>
        <div class="whitespace"></div>
        <iron-selector selected="{{selecteditem}}" on-iron-select="_showdetail">
          <template is="dom-repeat" items="{{dataobject}}">
            <locals-item class="prop">{{item.data.subject}}</locals-item>
          </template>
        </iron-selector>
        </div>
      </div>
      </neon-animatable>

      <neon-animatable>
        <div class="canvas">
        <locals-button on-tap="back">back</locals-button>
        <alabs-proposal class="props" ipfshash="{{selectedhash}}"></alabs-proposal>
      </div>
      </neon-animatable>

      <neon-animatable>
      <div class="canvas">
        <locals-button on-tap="back">back</locals-button>
        <alabs-proposal edit on-proposal-added="back"></alabs-proposal>
      </div>
      </neon-animatable>
      <neon-animatable>
        <locals-button on-tap="giveeth">Give me Ξ5</locals-button>
        <div>You have Ξ<span>{{balance}}</span></div>
      </neon-animatable>
    </neon-animated-pages>

    
  </template>

</dom-module>

<script>

  Polymer({

    is: 'alabs-voting',

    properties: {
      /**
       * Describes the author of the element, but is really just an excuse to
       * show off JSDoc annotations.
       *
       * @type {{name: string, image: string}}
       */
      clubid: {
        type: String,
        // Every club has it's own ID. This ID is used to get the data for this specific alabs-voting instance. The clubid is a whisper topic, where the last message is an IPFS hash containing the entire latest JSON object with references to contract id's.
        value: 'alabsvoting001'
      },

      web3: {
        // The web3 object: we bind this so we can interact with it. When it's ready, it fires a function _web3, this sets up the topic (clubid) subscription, so we can get the latest IPFS hash.
        type: Object,
        observer: '_web3'
      },

      dataobject: {
        // this is where our app gets it's data!
        type: Array,
        observer: '_dataobject'
      },

      balance: {
        type: Number,
        observer: '_balance'
      }

    },

    // Element Lifecycle

    ready: function() {
      this.state = 0;
      this.entryAnimation = "slide-from-right-animation";
      this.exitAnimation = "slide-left-animation";

      // `ready` is called after all elements have been configured, but
      // propagates bottom-up. This element's children are ready, but parents
      // are not.
      //
      // This is the point where you should make modifications to the DOM (when
      // necessary), or kick off any processes the element wants to perform.
    },

    attached: function() {
      // `attached` fires once the element and its parents have been inserted
      // into a document.
      //
      // This is a good place to perform any work related to your element's
      // visual state or active behavior (measuring sizes, beginning animations,
      // loading resources, etc).
    },

    detached: function() {
      // The analog to `attached`, `detached` fires when the element has been
      // removed from a document.
      //
      // Use this to clean up anything you did in `attached`.
    },

    _web3: function(){
      var self = this;
      // Here we subscribe to the clubid topic. When the IPFS hash is changed, we get to know it here.
      var dataobject = [];
      var fb = new Firebase('https://sponnet.firebaseio.com/alabs/proposals/');
      fb.on('value', function(snap){
        //console.log('ello fb ',snap.val());
        self.dataobject = self.object2array(snap.val());
        self.dataobject.reverse();
      });

      console.log(dataobject);
      self.dataobject = dataobject;

      //this.dataobject = dataobject;

        console.log('web3 started');

        // this.identity = this.web3.shh.newIdentity();

        // var filter = this.web3.shh.filter({
        //   "topics": [this.web3.fromAscii(this.clubid)],
        // });

        // filter.watch(function(error, result) {
        //   if (!error)
        //     console.log("ipfs hash? ", self.web3.toAscii(result.payload), JSON.parse(self.web3.toAscii(result.payload)));
        //     var result = JSON.parse(self.web3.toAscii(result.payload));
        //     console.log('hash is ', result.ipfshash);
        //     self.ipfshash = result.ipfshash; 
        // });

        //this.whisperpost("hash");

    },

    whisperpost: function(ipfshash) {
      console.log("im posting ", ipfshash);
      return this.web3.shh.post({
        "from": this.identity,
        "topics": [this.web3.fromAscii(this.clubid)],
        "payload": this.web3.fromAscii(JSON.stringify({
          ipfshash: ipfshash
        })),
        "ttl": 1000,
        "priority": 1000
      });
    },

    createNew: function(){
      this.state = 2;
    },

    back: function(){
      this.state = 0;
    },

    _dataobject: function(){
      var self = this;
      //this.items = this.object2array(this.dataobject);
      //var dataobject = this.dataobject;
      console.log(this.dataobject);
    },

    _showdetail: function(){
      console.log(this.dataobject[this.selecteditem]);
      this.selectedhash = this.dataobject[this.selecteditem].data.ipfshash;
      console.log(this.selectedhash);
      this.state = 1;
      //this.selecteditem = null;

    },

    _balance: function(){
        this.balans = this.balance / 1e18;
      },

    askEth: function(){
      //console.log('send me 1 testnet ether DAWG!');
      this.$.ajax.url = 'http://faucet.ma.cx:3000/donate/' + this.account;
      this.$.ajax.generateRequest();
    },

    hresponse: function(argument) {
      //console.log('iets?');
      //console.log(argument);
    },

    object2array: function(input){
        var newarray = [];
        var p = input;
        for (var key in p) {
          if (p.hasOwnProperty(key)) {
            newarray.push({data: p[key], key: key});
        }
      };
      return newarray;
    }


  });

</script>
