<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../web3-wallet/web3-wallet.html">
<link rel="import" href="../ipfs-upload/ipfs-upload.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../locals-button/locals-button.html">
<link rel="import" href="../locals-item/locals-item.html">
<link rel="import" href="../iron-selector/iron-selector.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <alabs-voting></alabs-voting>

@group Seed Elements
@element alabs-voting
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="alabs-voting">

  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
      }
    </style>

    <web3-wallet password="defaultpassword" host="http://109.123.70.141:8545" account="{{account}}" web3="{{web3}}" keystore="{{keystore}}"></web3-wallet>

    <ipfs-upload id="ipfsupload" host="/ip4/109.123.70.141/tcp/5001" ipfs="{{ipfs}}" hash="{{ipfshash}}"></ipfs-upload>

    <h1>&lt;alabs-voting&gt;</h1>
    <p>{{account}}</p>
    <paper-input label="new item" bind-value="{{newitem}}" value="{{newitem}}"></paper-input>
    <locals-button green on-tap="createNew">new</locals-button>
    <iron-selector selected="0">
      <template is="dom-repeat" items="{{votingitemslist}}">
        <locals-item>{{item.item}}</locals-item>
      </template>
    </iron-selector>
  </template>

</dom-module>

<script>

  Polymer({

    is: 'alabs-voting',

    properties: {
      /**
       * Describes the author of the element, but is really just an excuse to
       * show off JSDoc annotations.
       *
       * @type {{name: string, image: string}}
       */
      clubid: {
        type: String,
        // Every club has it's own ID. This ID is used to get the data for this specific alabs-voting instance. The clubid is a whisper topic, where the last message is an IPFS hash containing the entire latest JSON object with references to contract id's.
        value: 'alabsvoting001'
      },

      web3: {
        // The web3 object: we bind this so we can interact with it. When it's ready, it fires a function _web3, this sets up the topic (clubid) subscription, so we can get the latest IPFS hash.
        type: Object,
        observer: '_web3'
      },

      ipfs: {
        // The IPFS object exposes the ipfs-js api.
        type: Object
      },

      ipfshash: {
        // The ipfs hash gets a value from the web3 whisper topic. Upon getting the hash, we resolve (cat) the hash, so we get the JSON object used to populate the votingitemslist.
        type: String,
        observer: '_ipfshash'
      },

      dataobject: {
        // this is where our app gets it's data!
        type: Array,
        observer: '_dataobject'
      },

      votingitemslist: {
        type: Array,
        observer: '_dataobject'
      }

    },

    // Element Lifecycle

    ready: function() {
      this.votingitemslist = [];
      // `ready` is called after all elements have been configured, but
      // propagates bottom-up. This element's children are ready, but parents
      // are not.
      //
      // This is the point where you should make modifications to the DOM (when
      // necessary), or kick off any processes the element wants to perform.
    },

    attached: function() {
      // `attached` fires once the element and its parents have been inserted
      // into a document.
      //
      // This is a good place to perform any work related to your element's
      // visual state or active behavior (measuring sizes, beginning animations,
      // loading resources, etc).
    },

    detached: function() {
      // The analog to `attached`, `detached` fires when the element has been
      // removed from a document.
      //
      // Use this to clean up anything you did in `attached`.
    },

    _web3: function(){

      // Here we subscribe to the clubid topic. When the IPFS hash is changed, we get to know it here.

        var self = this;
        console.log('web3 started');

        this.identity = this.web3.shh.newIdentity();

        var filter = this.web3.shh.filter({
          "topics": [this.web3.fromAscii(this.clubid)],
        });

        filter.watch(function(error, result) {
          if (!error)
            console.log("ipfs hash? ", self.web3.toAscii(result.payload), JSON.parse(self.web3.toAscii(result.payload)));
            var result = JSON.parse(self.web3.toAscii(result.payload));
            console.log('hash is ', result.ipfshash);
            self.ipfshash = result.ipfshash; 
        });

        //this.whisperpost("hash");

    },

    whisperpost: function(ipfshash) {
      console.log("im posting ", ipfshash);
      return this.web3.shh.post({
        "from": this.identity,
        "topics": [this.web3.fromAscii(this.clubid)],
        "payload": this.web3.fromAscii(JSON.stringify({
          ipfshash: ipfshash
        })),
        "ttl": 1000,
        "priority": 1000
      });
    },

    _ipfshash: function(){
      var self = this;
      this.ipfs.cat(this.ipfshash).then(function(res){
        var buf = '';
          res
          .on('error', (err) => {
            expect(err).to.not.exist
          })
          .on('data', (data) => {
            buf += data
          })
          .on('end', () => {
            console.log(buf);
            self.votingitemslist = JSON.parse(buf);
          });
      });
    },

    _dataobject: function(){
      var self = this;


      //this.items = this.object2array(this.dataobject);

      var dataobject = this.dataobject;

      this.ipfs.add([new this.ipfs.Buffer(JSON.stringify(dataobject))], function(err, res){
        if(!err){
          console.log('ipfs result: ',res[0].Hash);
          self.ipfshash = res[0].Hash;
          self.whisperpost(res[0].Hash);
        }
      });
    },

    createNew: function(){
      this.push('votingitemslist', { item: this.newitem });
      console.log(this.items);
      this.newitem = '';
      this.dataobject = this.votingitemslist;
    },

    object2array: function(input){
        var newarray = [];
        var p = input;
        for (var key in p) {
          if (p.hasOwnProperty(key)) {
            newarray.push({data: p[key], key: key});
        }
      };
      return newarray;
    }

  });

</script>
